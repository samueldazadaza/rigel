<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador PDF MTTO STS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 40px 20px; }
        .card { background: white; max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); font-size: 1.5rem; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; }
        textarea { width: 100%; height: 60px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        .drop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .drop-zone { border: 2px dashed #cbd5e1; height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: #f8fafc; overflow: hidden; border-radius: 10px; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--accent); background: #f0f7ff; }
        .drop-zone img { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .drop-zone span { font-size: 0.8rem; text-align: center; color: #64748b; padding: 5px; }
        button { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        button:hover { background: #000; transform: translateY(-1px); }
        #status { text-align: center; color: #10b981; margin-bottom: 15px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h1>Generador de PDF MTTO Preventivo STS</h1>

    <div class="input-group">
        <label>ID del Bus:</label>
        <textarea id="texto" placeholder="Ej: Z67-4111"></textarea>
    </div>

    <div id="config-encabezados" style="display:none;">
        <span id="txt-h1">Evidencia de informaciÃ³n SSD</span>
        <span id="txt-h2">Evidencia de cÃ¡maras activas</span>
        <span id="txt-h3">Evidencia de grabaciones</span>
        <span id="txt-fijo-derecha">Mantenimiento Preventivo STS mÃ³vil: </span>
    </div>

    <div class="drop-grid">
        <div class="drop-zone" id="dz-1"><span>ðŸ“· Foto 1<br>SSD</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-2"><span>ðŸ“· Foto 2<br>CAM</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-3"><span>ðŸ“· Foto 3<br>GRAB</span><input type="file" hidden accept="image/*"></div>
    </div>

    <div id="status">âœ… ImÃ¡genes cargadas correctamente</div>
    <button onclick="generarPDF()">Descargar PDF Reporte</button>
</div>

<script>
    const imagesData = [null, null, null];

    document.querySelectorAll('.drop-zone').forEach((zone, index) => {
        const input = zone.querySelector('input');
        zone.onclick = () => input.click();
        zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = "#3b82f6"; };
        zone.ondragleave = () => { zone.style.borderColor = "#cbd5e1"; };
        zone.ondrop = (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) procesar(e.dataTransfer.files[0], index, zone);
        };
        input.onchange = () => { if (input.files.length) procesar(input.files[0], index, zone); };
    });

    async function procesar(file, index, zone) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_W = 1800; // Alta nitidez
                const scale = MAX_W / img.width;
                canvas.width = MAX_W;
                canvas.height = img.height * scale;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const b64 = canvas.toDataURL('image/jpeg', 0.7);
                imagesData[index] = b64;
                zone.innerHTML = `<img src="${b64}">`;
                if (imagesData.every(i => i !== null)) document.getElementById('status').style.display = 'block';
            };
        };
    }

    function dibujarEncabezados(doc, numPagina, variableTexto) {
        const textoFijoDerecha = document.getElementById('txt-fijo-derecha').innerText;
        const encabezadoIzquierdo = document.getElementById(`txt-h${numPagina}`).innerText;
        
        doc.setFontSize(9);
        doc.setTextColor(100);

        // Izquierda (5mm desde el borde)
        doc.text(encabezadoIzquierdo, 5, 8);

        // Derecha (5mm desde el borde derecho: 297 - 5 = 292)
        const textoDerecha = textoFijoDerecha + variableTexto.trim();
        doc.text(textoDerecha, 292, 8, { align: 'right' });
        
        doc.setTextColor(0);
    }

    function generarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
        const textoInput = document.getElementById('texto').value || "SIN_ID";
        const margenLateral = 20;

        imagesData.forEach((img, i) => {
            if (i > 0) doc.addPage('a4', 'l');
            
            // 1. Dibujar Encabezados
            dibujarEncabezados(doc, i + 1, textoInput);

            // 2. Definir punto de inicio para la imagen (yOffset)
            // Como quitaste el tÃ­tulo grande, empezamos mÃ¡s arriba (ej: 15mm)
            const yOffset = 15;

            // 3. Imagen con ProporciÃ³n
            if (img) {
                const props = doc.getImageProperties(img);
                const ratio = props.width / props.height;
                
                let w = 257; // Ancho disponible (297 - 20 - 20)
                let h = w / ratio;

                // Si la imagen es muy alta, ajustamos por el alto disponible
                const altoMaximo = 210 - yOffset - 10; // 210 total - inicio - margen inferior
                if (h > altoMaximo) {
                    h = altoMaximo;
                    w = h * ratio;
                }

                // Centrar horizontalmente si el ancho es menor al disponible
                const xCentrado = (297 - w) / 2;

                doc.addImage(img, 'JPEG', xCentrado, yOffset, w, h);
            }
        });

        // Nombre de archivo: texto + fecha_hora
        const ahora = new Date();
        const textoLimpio = textoInput.slice(0, 15).replace(/[^a-z0-9]/gi, '_');
       // const stamp = `${ahora.getYear()}-${ahora.getMonth()}-${ahora.getDate()+1}_${ahora.getHours()}${ahora.getMinutes()}`;
        
        doc.save(`${textoLimpio}_mantenimiento_preventivo.pdf`);
    }
</script>
</body>
</html>
