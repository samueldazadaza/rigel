<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Landscape Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f1f5f9; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); padding: 40px 20px; color: #334155; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; margin-top: 0; color: var(--primary); font-weight: 800; }
        .field-label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 0.9rem; }
        
        textarea { 
            width: 100%; height: 80px; padding: 12px; border: 2px solid #e2e8f0; 
            border-radius: 10px; resize: none; box-sizing: border-box; transition: border 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--accent); }

        .drop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 25px 0; }
        .drop-zone { 
            border: 2px dashed #cbd5e1; border-radius: 12px; height: 180px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; background: #f8fafc; overflow: hidden;
        }
        .drop-zone:hover { border-color: var(--accent); background: #f0f7ff; }
        .drop-zone img { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .drop-zone span { font-size: 0.75rem; color: #64748b; font-weight: 500; }

        .btn-container { text-align: center; }
        button { 
            background: var(--primary); color: white; border: none; padding: 14px 40px; 
            border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        #status { color: #10b981; font-weight: 600; margin-bottom: 15px; display: none; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Generador PDF Horizontal</h2>
    
    <span class="field-label">Descripción del documento</span>
    <textarea id="texto" placeholder="Escribe las notas que irán en el PDF..."></textarea>

    <div class="drop-grid">
        <div class="drop-zone" id="dz-1"><span>➕ Foto 1</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-2"><span>➕ Foto 2</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-3"><span>➕ Foto 3</span><input type="file" hidden accept="image/*"></div>
    </div>

    <div id="status">✨ ¡Imágenes listas!</div>

    <div class="btn-container">
        <button onclick="generarPDF()">Descargar PDF A4 Horizontal</button>
    </div>
</div>

<script>
    const imagesData = [null, null, null];

    document.querySelectorAll('.drop-zone').forEach((zone, index) => {
        const input = zone.querySelector('input');
        zone.onclick = () => input.click();
        zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = "#3b82f6"; };
        zone.ondragleave = () => zone.style.borderColor = "#cbd5e1";
        zone.ondrop = (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) procesarImagen(e.dataTransfer.files[0], index, zone);
        };
        input.onchange = () => {
            if (input.files.length) procesarImagen(input.files[0], index, zone);
        };
    });

    async function procesarImagen(file, index, zone) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Redimensionamiento inteligente para no exceder 1MB
                const MAX_W = 1200;
                const scale = MAX_W / img.width;
                canvas.width = MAX_W;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const finalBase64 = canvas.toDataURL('image/jpeg', 0.7);
                imagesData[index] = finalBase64;
                zone.innerHTML = `<img src="${finalBase64}">`;
                
                if (imagesData.every(i => i !== null)) document.getElementById('status').style.display = 'block';
            };
        };
    }

    function generarPDF() {
        const { jsPDF } = window.jspdf;
        // 'l' = landscape (horizontal)
        const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
        
        const margen = 20;
        const pageWidth = 297; 
        const pageHeight = 210;
        const contentWidth = pageWidth - (margen * 2);
        const contentHeight = pageHeight - (margen * 2);
        
        const texto = document.getElementById('texto').value;

        // TÍTULO / TEXTO
        doc.setFontSize(12);
        const textLines = doc.splitTextToSize(texto, contentWidth);
        doc.text(textLines, margen, margen + 5);
        
        // Espacio ocupado por el texto
        let yCursor = margen + 10 + (textLines.length * 5);

        // PROCESAR IMÁGENES
        imagesData.forEach((imgBase64, i) => {
            if (!imgBase64) return;

            // Si ya no cabe en la primera página o si queremos una foto por página después del texto
            if (i > 0 || yCursor > 100) { 
                doc.addPage('a4', 'l');
                yCursor = margen;
            }

            const props = doc.getImageProperties(imgBase64);
            const imgRatio = props.width / props.height;
            
            // Calculamos dimensiones máximas respetando márgenes
            let targetW = contentWidth;
            let targetH = targetW / imgRatio;

            // Ajuste de seguridad: si el alto calculado se sale de la página
            if (targetH > (pageHeight - yCursor - margen)) {
                targetH = pageHeight - yCursor - margen;
                targetW = targetH * imgRatio;
            }

            doc.addImage(imgBase64, 'JPEG', margen, yCursor, targetW, targetH);
            yCursor += targetH + 10;
        });

        doc.save("documento_horizontal.pdf");
    }
</script>
</body>
</html>
