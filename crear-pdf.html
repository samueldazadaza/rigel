<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF con Encabezados - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 40px 20px; }
        .card { background: white; max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); }
        .input-group { margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; }
        .drop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .drop-zone { border: 2px dashed #cbd5e1; height: 160px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f8fafc; overflow: hidden; border-radius: 10px; }
        .drop-zone img { width: 100%; height: 100%; object-fit: contain; background: #000; }
        button { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        button:hover { background: #000; }
        #status { text-align: center; color: #10b981; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h1>Generador de Reporte A4</h1>

    <div class="input-group">
        <label><b>Contenido General:</b></label>
        <textarea id="texto" placeholder="Escribe el nombre del proyecto o descripción..."></textarea>
    </div>

    <div id="config-encabezados" style="display:none;">
        <span id="txt-h1">Encabezado Hoja 1</span>
        <span id="txt-h2">Encabezado Hoja 2</span>
        <span id="txt-h3">Encabezado Hoja 3</span>
        <span id="txt-fijo-derecha">PROYECTO: </span>
    </div>

    <div class="drop-grid">
        <div class="drop-zone" id="dz-1"><span>Foto 1</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-2"><span>Foto 2</span><input type="file" hidden accept="image/*"></div>
        <div class="drop-zone" id="dz-3"><span>Foto 3</span><input type="file" hidden accept="image/*"></div>
    </div>

    <div id="status">✅ Imágenes listas</div>
    <button onclick="generarPDF()">Descargar PDF con Encabezados</button>
</div>

<script>
    const imagesData = [null, null, null];

    document.querySelectorAll('.drop-zone').forEach((zone, index) => {
        const input = zone.querySelector('input');
        zone.onclick = () => input.click();
        zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = "#3b82f6"; };
        zone.ondrop = (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) procesar(e.dataTransfer.files[0], index, zone);
        };
        input.onchange = () => { if (input.files.length) procesar(input.files[0], index, zone); };
    });

    async function procesar(file, index, zone) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // CALIDAD AJUSTADA: 1800px para nitidez
                const MAX_W = 1800; 
                const scale = MAX_W / img.width;
                canvas.width = MAX_W;
                canvas.height = img.height * scale;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // CALIDAD AJUSTADA: 0.8 para mejor balance
                const b64 = canvas.toDataURL('image/jpeg', 0.8);
                imagesData[index] = b64;
                zone.innerHTML = `<img src="${b64}">`;
                if (imagesData.every(i => i !== null)) document.getElementById('status').style.display = 'block';
            };
        };
    }

    function dibujarEncabezados(doc, numPagina, variableTexto) {
        const textoFijoDerecha = document.getElementById('txt-fijo-derecha').innerText;
        const encabezadoIzquierdo = document.getElementById(`txt-h${numPagina}`).innerText;
        
        doc.setFontSize(9);
        doc.setTextColor(100);

        // Izquierda (5mm, 5mm)
        doc.text(encabezadoIzquierdo, 5, 8);

        // Derecha (Casi al borde 297mm - 5mm = 292mm)
        const textoDerecha = textoFijoDerecha + variableTexto.slice(0, 40);
        doc.text(textoDerecha, 292, 8, { align: 'right' });
        
        doc.setTextColor(0); // Reset color a negro para el resto
    }

    function generarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
        const textoInput = document.getElementById('texto').value || "Sin Titulo";
        const margenLateral = 20;

        imagesData.forEach((img, i) => {
            if (i > 0) doc.addPage('a4', 'l');
            
            // 1. Dibujar Encabezados (se repite en cada página)
            dibujarEncabezados(doc, i + 1, textoInput);

            // 2. Título principal (solo en la primera hoja si lo deseas, o en todas)
            if (i === 0) {
                doc.setFontSize(14);
                const lines = doc.splitTextToSize(textoInput, 257);
                doc.text(lines, margenLateral, 25);
                var yOffset = 35 + (lines.length * 5);
            } else {
                var yOffset = 20;
            }

            // 3. Imagen con Proporción
            if (img) {
                const props = doc.getImageProperties(img);
                const ratio = props.width / props.height;
                let w = 257; 
                let h = w / ratio;

                // Ajuste si la imagen es muy alta
                if (h > (210 - yOffset - 15)) {
                    h = 210 - yOffset - 15;
                    w = h * ratio;
                }
                doc.addImage(img, 'JPEG', margenLateral, yOffset, w, h);
            }
        });

        // Nombre de archivo con Fecha y Hora
        const ahora = new Date();
        const stamp = `${ahora.getHours()}${ahora.getMinutes()}_${ahora.getDate()}-${ahora.getMonth()+1}`;
        doc.save(`Reporte_${stamp}.pdf`);
    }
</script>
</body>
</html>
